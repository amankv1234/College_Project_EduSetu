<%- include("partials/navbar") %>

<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ADD YOUR GEMINI API KEY HERE -->
  <script>
    const GEMINI_API_KEY = "AIzaSyBtNccIBw63zaK9x7doYnECIgCCE_5LZXI"; 
  </script>

  <style>
    .glass {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(14px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    .chat-scroll { max-height: 60vh; overflow-y: auto; }
    .bubble { word-wrap: break-word; white-space: pre-wrap; }
    .typing-dot {
      display:inline-block;width:8px;height:8px;
      background:white;border-radius:50%;
      margin-right:6px;animation: blink 1s infinite;
    }
    .typing-dot:nth-child(2){ animation-delay:.2s }
    .typing-dot:nth-child(3){ animation-delay:.4s }
    @keyframes blink {
      0%{opacity:.2; transform: translateY(0)}
      50%{opacity:1; transform: translateY(-4px)}
      100%{opacity:.2; transform: translateY(0)}
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 to-indigo-800 min-h-screen">

<main class="max-w-7xl mx-auto py-8 px-4 grid lg:grid-cols-3 gap-6">

  <!-- ---------------- LEFT PANEL ---------------- -->
  <section class="lg:col-span-1 space-y-6">

    <!-- INTRO -->
    <div class="glass p-6 text-white mt-10">
      <h2 class="text-2xl font-bold">EduSetu AI Assistant ü§ñ</h2>
      <p class="text-sm mt-1 opacity-80">
        Study help ¬∑ Coding help ¬∑ Career guidance ¬∑ DSA ¬∑ Projects
      </p>
    </div>

    <!-- QUICK PROMPTS -->
    <div class="glass p-5 text-white">
      <h3 class="text-lg font-semibold mb-3">‚ö° Quick Prompts</h3>

      <div class="grid grid-cols-1 gap-2">
        <button class="quick p-2 rounded bg-white/10" data-p="Create a 1-month roadmap for full stack dev.">Full-Stack Roadmap</button>
        <button class="quick p-2 rounded bg-white/10" data-p="Give me 10 DSA problems I must solve.">DSA Problems</button>
        <button class="quick p-2 rounded bg-white/10" data-p="Suggest unique project ideas for portfolio.">Project Ideas</button>
        <button class="quick p-2 rounded bg-white/10" data-p="Guide me for internship preparation.">Internship Prep</button>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="glass p-5 text-white">
      <h3 class="text-lg font-semibold mb-3">‚öôÔ∏è Settings</h3>

      <label>Model</label>
      <select id="model" class="w-full p-2 mt-1 rounded bg-white/10">
        <option value="gemini-pro">Gemini Pro (recommended)</option>
        <option value="gemini-1.5-flash">Gemini Flash</option>
      </select>

      <label class="mt-4 block">Temperature: <span id="tempVal">0.7</span></label>
      <input id="temp" type="range" min="0" max="1" value="0.7" step="0.1" class="w-full">

      <!-- Memory toggle -->
      <div class="flex items-center gap-2 mt-4">
        <input id="memoryToggle" type="checkbox" class="w-4 h-4">
        <label for="memoryToggle">Enable Memory (future backend)</label>
      </div>

      <!-- STATS -->
      <p class="text-xs opacity-80 mt-4">Messages: <span id="msgCount">0</span></p>
      <p class="text-xs opacity-80">Characters typed: <span id="charCount">0</span></p>

      <div class="mt-4 flex gap-2">
        <button id="clear" class="flex-1 p-2 bg-red-500 rounded">Clear</button>
        <button id="download" class="flex-1 p-2 bg-emerald-600 rounded">Download</button>
      </div>
    </div>

    <!-- FILE UPLOAD -->
    <div class="glass p-5 text-white">
      <h3 class="font-semibold text-lg mb-2">üìÑ Upload Document (UI only)</h3>
      <input id="fileInput" type="file" class="text-white/90">
      <p class="text-xs mt-2 opacity-80">Upload PDF/DOC for AI (backend later)</p>
    </div>

  </section>

  <!-- ---------------- RIGHT PANEL ---------------- -->
  <section class="lg:col-span-2 glass p-6 text-white flex flex-col mt-10">

    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">Chat with EduSetu</h3>
      <button id="historyBtn" class="px-3 py-1 bg-white/10 rounded">History</button>
    </div>

    <!-- CHAT MESSAGES -->
    <div id="messages" class="chat-scroll mb-4 space-y-3">
      <div class="flex gap-3">
        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">A</div>
        <div class="bubble bg-white/10 p-3 rounded-lg">
          Hello Aman! I'm here to help you with your complete tech journey.
        </div>
      </div>
    </div>

    <!-- TYPING -->
    <div id="typing" class="hidden text-sm mb-2">
      <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
      <span class="ml-2">Typing‚Ä¶</span>
    </div>

    <!-- INPUT -->
    <form id="chatForm" class="flex gap-2">
      <textarea id="input" rows="1" placeholder="Ask anything‚Ä¶" class="flex-1 p-3 rounded bg-white text-black"></textarea>
      <button class="px-4 bg-indigo-600 rounded">Send</button>
    </form>

  </section>

</main>


<!-- ---------------- HISTORY DRAWER ---------------- -->
<div id="drawer" class="fixed top-0 right-0 h-full w-80 bg-slate-800 text-white p-5 hidden shadow-xl">
  <h3 class="font-semibold text-lg">Conversation History</h3>
  <ul id="historyList" class="mt-4 space-y-2 text-sm"></ul>
</div>



<script>

/* ---------------- GEMINI API FUNCTION ---------------- */
async function getGeminiResponse(prompt, model, temperature) {
  const url = `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${GEMINI_API_KEY}`;

  const body = {
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { temperature: Number(temperature) }
  };

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    return (
      data.candidates?.[0]?.content?.parts?.[0]?.text ||
      "‚ö†Ô∏è No response from Gemini model."
    );

  } catch (err) {
    return "‚ùå Error connecting to Gemini API.";
  }
}

/* ---------------- VARIABLES ------------------- */
const messagesEL = document.getElementById("messages");
const input = document.getElementById("input");
const msgCount = document.getElementById("msgCount");
const charCount = document.getElementById("charCount");
const drawer = document.getElementById("drawer");

/* QUICK PROMPTS */
document.querySelectorAll(".quick").forEach(btn=>{
  btn.onclick = ()=> input.value = btn.dataset.p;
});

/* ADD MESSAGE BUBBLE */
function addMsg(role,text){
  const wrap=document.createElement("div");
  wrap.className="flex gap-3 "+(role==="user"?"justify-end":"");

  const avatar=document.createElement("div");
  avatar.className="w-10 h-10 rounded-full flex items-center justify-center "+(role==="user"?"bg-indigo-500":"bg-white/20");
  avatar.textContent=role==="user"?"U":"A";

  const bubble=document.createElement("div");
  bubble.className="bubble p-3 rounded-lg "+(role==="user"?"bg-indigo-600":"bg-white/10");
  bubble.textContent=text;

  if(role==="user"){wrap.appendChild(bubble);wrap.appendChild(avatar);}
  else{wrap.appendChild(avatar);wrap.appendChild(bubble);}

  messagesEL.appendChild(wrap);
  messagesEL.scrollTop=messagesEL.scrollHeight;

  updateStats(text);
  saveLocal();
}

/* STATS */
let msgCounter=0, charCounter=0;
function updateStats(txt){
  msgCounter++; msgCount.textContent=msgCounter;
  charCounter+=txt.length; charCount.textContent=charCounter;
}

/* LOCAL STORAGE */
function saveLocal(){ localStorage.setItem("edusetuChat", messagesEL.innerHTML); }
function loadLocal(){
  const data = localStorage.getItem("edusetuChat");
  if(data) messagesEL.innerHTML=data;
}
loadLocal();

/* TYPING ANIMATION */
function showTyping(){
  return new Promise(res=>{
    document.getElementById("typing").classList.remove("hidden");
    setTimeout(()=>{
      document.getElementById("typing").classList.add("hidden");
      res();
    },600);
  });
}

/* -------------- HANDLE SEND MESSAGE --------------- */
document.getElementById("chatForm").addEventListener("submit", async(e)=>{
  e.preventDefault();
  const text=input.value.trim();
  if(!text) return;

  addMsg("user",text);
  input.value="";

  await showTyping();

  const model = document.getElementById("model").value;
  const temp = document.getElementById("temp").value;

  const reply = await getGeminiResponse(text, model, temp);

  addMsg("assistant", reply);
});

/* CLEAR */
document.getElementById("clear").onclick=()=>{
  messagesEL.innerHTML="";
  localStorage.removeItem("edusetuChat");
};

/* DOWNLOAD CHAT */
document.getElementById("download").onclick=()=>{
  let txt="";
  document.querySelectorAll(".bubble").forEach(b=>txt+=b.innerText+"\n\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([txt],{type:"text/plain"}));
  a.download="edusetu_chat.txt";
  a.click();
};

/* HISTORY DRAWER */
document.getElementById("historyBtn").onclick=()=>{
  drawer.classList.toggle("hidden");
  document.getElementById("historyList").innerHTML="";
  document.querySelectorAll(".bubble").forEach(b=>{
    const li=document.createElement("li");
    li.textContent=b.innerText.slice(0,50)+"...";
    document.getElementById("historyList").appendChild(li);
  });
};

</script>

</body>
</html>
